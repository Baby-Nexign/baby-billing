# API-автотесты для проекта "Baby-Billing"

Этот проект содержит автоматизированные тесты для API сервисов системы "Baby-Billing". Тесты написаны на Java с использованием RestAssured и JUnit 5.

## Назначение

Цель этих тестов — проверка корректности работы API-эндпоинтов различных сервисов системы "Baby-Billing", включая аутентификацию, авторизацию, основные бизнес-операции и обработку ошибок.

## Предварительные требования

1.  **Java JDK**: Версия 17 или выше.
2.  **Apache Maven**: Для сборки проекта и запуска тестов.
3.  **Запущенное приложение "Baby-Billing"**: Все сервисы должны быть запущены (например, через `docker compose up -d` из корневой директории проекта `baby-billing`) и доступны по адресу `http://localhost:8084`.

## Используемые технологии
* Java
* RestAssured
* JUnit 5
* Apache Maven

## Структура проекта
Проект API-тестов находится в директории `baby-billing/auto-tests/api_tests`.
Основная структура исходного кода тестов (`src/test/java/org/example/`):
```
.
├── auth                        # Тесты для сервиса аутентификации
│   ├── LoginTests.java         # Тесты эндпоинта /api/auth/login
│   └── RegisterTests.java      # Тесты эндпоинта /api/auth/register
├── brt                         # Тесты для BRT-сервиса
│   └── BrtPersonTests.java     # Тесты эндпоинтов /api/person/*
├── cdr                         # Тесты для Commutator-сервиса (ранее commutator)
│   └── CommutatorServiceTests.java # Тесты эндпоинта /api/commutator/generate-cdr
├── config                      # Конфигурационные классы
│   └── ApiTestConfig.java      # Базовые URL, константы, спецификации RestAssured
├── helpers                     # Вспомогательные классы и утилиты
│   ├── AuthHelper.java         # Утилиты для получения JWT-токенов
│   ├── BaseApiTest.java        # Базовый класс для тестов с общей настройкой
│   └── TestDataGenerator.java  # Генерация тестовых данных и тел запросов
└── hrs                         # Тесты для HRS-сервиса
└── HrsServiceTests.java    # Тесты эндпоинтов /api/services/* и /api/tariffs/*
```
* `pom.xml`: Файл конфигурации Maven с зависимостями (RestAssured, JUnit 5, Jackson и др.).

## Запуск тестов

1.  **Перейдите в директорию проекта API-тестов**:
    ```bash
    cd baby-billing/auto-tests/api_tests
    ```
2.  **Запуск всех тестов**:
    Для запуска всех тестов с помощью Maven выполните команду:
    ```bash
    mvn clean test
    ```
3.  **Запуск тестов с определенным тегом**:
    Тесты помечены тегами JUnit 5 (например, `@Tag("brt")`, `@Tag("auth")`). Для запуска тестов с определенным тегом:
    ```bash
    mvn test -Dgroups="brt" 
    ```
    (для запуска тестов, помеченных тегом "brt")

    Для запуска нескольких групп тегов:
    ```bash
    mvn test -Dgroups="brt,hrs"
    ```

## Интеграция с Allure Report

Для получения детализированных и наглядных отчетов о выполнении тестов данный проект интегрирован с Allure Report.

### Установка Allure

1.  **Allure Pytest Adapter**: Библиотека `allure-pytest` должна быть уже включена в файл `requirements.txt` и установлена вместе с остальными зависимостями на шаге `pip install -r requirements.txt`.
2.  **Allure Commandline**: Для генерации HTML-отчета необходим установленный Allure Commandline. Инструкции по его установке для вашей операционной системы можно найти на [официальном сайте Allure Framework](https://allurereport.org/docs/gettingstarted-installation/).

### Запуск тестов для генерации Allure-данных

Чтобы Pytest собрал данные для Allure Report, используйте ключ `--alluredir`, указав директорию для сохранения результатов (обычно `allure-results`):

```bash
# Запуск всех тестов и сохранение результатов для Allure
mvn clean test -U
```

### Генерация и просмотр отчета Allure

После того как тесты выполнены и данные сохранены в `allure-results`:

1.  **Сгенерируйте HTML-отчет**:
    ```bash
    allure generate allure-results --clean -o allure-report
    ```
    * `allure-results` – папка с результатами выполнения тестов.
    * `--clean` – удаляет предыдущий сгенерированный отчет перед созданием нового.
    * `-o allure-report` – указывает папку, в которую будет помещен сгенерированный HTML-отчет (например, `allure-report`).

2.  **Откройте сгенерированный отчет**:
    ```bash
    allure open allure-report
    ```
    Эта команда запустит локальный веб-сервер и попытается открыть отчет в вашем браузере по умолчанию.


## Покрытие API

Тесты покрывают следующие сервисы и их основные эндпоинты:
* **Auth Service**: Регистрация и логин пользователей (администраторы, абоненты).
* **Commutator Service**: Генерация CDR-записей.
* **BRT Service**: Управление абонентами (создание, смена тарифа, пополнение баланса, получение информации).
* **HRS Service**: Управление услугами и тарифами (получение списков, получение по ID, создание).


## Обзор тестовых сценариев

Текущий набор API-автотестов сфокусирован на проверке следующих аспектов для каждого сервиса:

**1. Сервис Аутентификации (`Auth Service` - эндпоинты `/api/auth/*`)**
* **Логин (`POST /login`):**
    * Успешный вход администратора.
    * Успешный вход абонента (по MSISDN).
    * Неуспешный вход с неверным паролем.
    * Неуспешный вход для несуществующего пользователя.
* **Регистрация (`POST /register`):**
    * Успешная регистрация нового администратора.
    * Успешная регистрация нового абонента (с MSISDN, известным BRT).
    * Неуспешная регистрация при дублировании `username` или `msisdn`.
    * Неуспешная регистрация абонента, если его `msisdn` не найден в BRT.
    * Неуспешная регистрация без указания `username` или `msisdn`.

**2. Сервис Коммутатора (`Commutator Service` - эндпоинты `/api/commutator/*`)**
* **Генерация CDR (`POST /generate-cdr`):**
    * Успешная инициация генерации администратором.
    * Запрет на инициацию генерации для роли "абонент" (ошибка 403).

**3. BRT Сервис (Биллинг и Тарификация - эндпоинты `/api/person/*`)**
* **Создание абонента (`POST /person`):**
    * Успешное создание нового абонента администратором (проверка ответа 201 и возвращаемых данных).
    * Запрет на создание абонента для роли "абонент" (ошибка 403).
* **Смена тарифа абонента (`PUT /person/tariff`):**
    * Успешная смена тарифа администратором.
    * Успешная смена тарифа абонентом для самого себя.
    * Запрет на смену тарифа абонентом для другого абонента (ошибка 403).
* **Пополнение баланса (`PUT /person/{msisdn}/balance`):**
    * Успешное пополнение баланса администратором.
    * Успешное пополнение баланса абонентом для самого себя.
    * Запрет на пополнение баланса абонентом для другого абонента (ошибка 403).
* **Получение информации об абоненте (`GET /person/{msisdn}`):**
    * Успешное получение информации администратором.
    * Успешное получение информации абонентом о самом себе.
    * Запрет на получение информации абонентом о другом абоненте (ошибка 403).
    * Получение ошибки 404 при запросе информации о несуществующем абоненте.

**4. HRS Сервис (Тарифы и Услуги - эндпоинты `/api/services/*` и `/api/tariffs/*`)**
* **Услуги (`/api/services`):**
    * `GET /services`: Успешное получение списка услуг (неаутентифицированный пользователь, администратор).
    * `GET /services/{serviceId}`:
        * Успешное получение существующей услуги по ID (неаутентифицированный пользователь).
        * Получение ошибки 404 для несуществующей услуги.
    * `POST /services`:
        * Успешное "создание" услуги администратором (с учетом текущей реализации-заглушки, проверка статуса 200).
        * Запрет на создание услуги для роли "абонент" (ошибка 403).
* **Тарифы (`/api/tariffs`):**
    * `GET /tariffs`: Успешное получение списка тарифов (неаутентифицированный пользователь, администратор).
    * `GET /tariffs/{tariffId}`:
        * Успешное получение существующего тарифа по ID (неаутентифицированный пользователь).
        * Получение ошибки 404 для несуществующего тарифа.
    * `POST /tariffs`:
        * Успешное "создание" тарифа администратором (с учетом текущей реализации-заглушки, проверка статуса 200).
        * Запрет на создание тарифа для роли "абонент" (ошибка 403).
