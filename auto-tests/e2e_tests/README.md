# E2E (End-to-End) Тесты для baby-billing

Данный раздел содержит E2E (End-to-End) тесты для проекта `baby-billing`. Эти тесты предназначены для проверки сквозного взаимодействия различных сервисов системы, имитируя реальные сценарии использования. Основное внимание уделяется корректности биллинговых операций, обработке вызовов для абонентов с различными тарифными планами и проверке изменения их балансов и пакетных услуг.

## Общие требования и настройка

Для первоначальной установки проекта `baby-billing` обратитесь к основному файлу `README.md`, расположенному в корневой директории `auto-tests`.

### Подготовка к запуску E2E тестов:

После выполнения общих шагов по настройке проекта `baby-billing`, выполните следующие команды для подготовки окружения E2E тестов:

```bash
# 1. Убедитесь, что все сервисы baby-billing запущены (docker compose up -d в корне проекта)

# 2. Перейдите в директорию E2E тестов
# (путь от корневой директории baby-billing)
cd auto-tests/e2e_tests

# 3. Создайте и активируйте виртуальное окружение Python
python -m venv .venv
# Для Linux/MacOS:
source .venv/bin/activate
# Для Windows:
# .venv\Scripts\activate

# 4. Установите зависимости Python для E2E тестов
pip install -r requirements.txt
```

## Запуск E2E тестов

1.  Убедитесь, что все сервисы `baby-billing` запущены.
2.  Перейдите в директорию `auto-tests/e2e_tests`.
3.  Активируйте виртуальное окружение Python.
4.  Выполните команду:

    Для запуска всех E2E тестов с подробным выводом:
    ```bash
    pytest -v
    ```

    Для запуска тестов из конкретного файла:
    ```bash
    pytest -v tests/test_e2e_classic_01.py
    ```

## Структура проекта `e2e_tests`

```
e2e_tests/
├── tests/                      # Модули с тестами Pytest
│   ├── conftest.py             # Общие фикстуры (напр., подключение к БД)
│   ├── test_e2e_classic_01.py  # Тесты для тарифного плана "Классика"
│   ├── test_e2e_classic_02.py
│   ├── test_e2e_classic_03.py
│   ├── test_e2e_monthly_01.py  # Тесты для тарифного плана "Помесячный"
│   ├── test_e2e_monthly_02.py
│   └── test_e2e_monthly_03.py
├── .env                        # Конфигурационный файл (требуется создать на основе .env.example, если есть)
├── config.py                   # Загрузка конфигурации тестов из .env
├── database.py                 # Утилиты для взаимодействия с БД PostgreSQL (BRT)
├── rabbitmq_sender.py          # Модуль для отправки CDR в RabbitMQ
├── requirements.txt            # Зависимости Python
├── subscriber_schema.py        # Pydantic схема для данных абонента
└── utils.py                    # Вспомогательные утилиты (например, расчет биллинговых минут)
```

## Описание тестовых сценариев

E2E тесты реализуют [ручные тесты из ДЗ](https://docs.google.com/spreadsheets/d/1LoakVyama-IxQEB4WEeSl6YAoXoj4UniGqng_Kefsx8/edit?gid=123041164#gid=123041164) и покрывают следующие основные сценарии:

* **Тариф "Классика" (`test_e2e_classic_*.py`)**:
    * Проверка корректного списания средств при исходящих внутрисетевых звонках.
    * Проверка тарификации исходящих звонков на номера других операторов.
    * Проверка отсутствия списаний за входящие звонки.
* **Тариф "Помесячный" (`test_e2e_monthly_*.py`)**:
    * Проверка списания минут из пакета при исходящих звонках (внутрисетевых и на другие сети) в пределах остатка пакета.
    * Проверка частичного списания из пакета и последующей тарификации деньгами, если длительность звонка превышает остаток минут в пакете.
    * Корректный расчет стоимости сверх пакетных минут для разных направлений (внутрисеть/внешние сети).

Каждый тест подготавливает необходимые данные об абонентах в базе данных BRT-сервиса, отправляет тестовые CDR-сообщения через RabbitMQ и затем проверяет состояние абонентов (баланс, остаток пакетных минут) после обработки этих CDR системой.

## Изменение параметров тестов вручную

В каждом тестовом файле (например, `test_e2e_classic_01.py`) параметры для конкретного сценария обычно определены в виде констант в начале файла. Это позволяет легко изменять входные данные для проверки различных условий без изменения логики самого теста.

**Пример констант из файла `test_e2e_classic_01.py`**:
```python
# --- Константы для теста E2E-CLASSIC-01 ----
MSISDN_CALLER = "79111111111"
MSISDN_CALLEE = "79333333333"
INITIAL_BALANCE_CALLER = 50
INITIAL_BALANCE_CALLEE = 60

CDR_CALL_TYPE = "01"
CDR_CALL_START = "2025-05-01T10:00:00"
CDR_CALL_END = "2025-05-01T10:03:45"

COST_PER_MINUTE = 15  # Стоимость минуты для ТП "Классика" при звонке на своего оператора
DEFAULT_TARIFF_ID = 11 # ID тарифа "Классика"
```
Вы можете изменять значения этих констант (например, `MSISDN_CALLER`, `INITIAL_BALANCE_CALLER`, даты `CDR_CALL_START` и `CDR_CALL_END`, и т.д.) непосредственно в файле теста перед его запуском для проверки специфических ситуаций или отладки.
